# 分布式事务整理

1. 2阶段提交 2PC
   1.  单点故障 协调者失败以后就所有的都会失败
   2. 阻塞： 所有的事务参与者都是阻塞状态的一直在占用资源
   3. 数据不一致，如果在提交过程中有网络分区，导致部分的参与者没有收到提交操作，就会导致数据不一致问题。 
2. 3PC 3阶段提交
   1. 阶段组成
      1. 准备阶段，协调者只询问，然后参与者查询资源
      2. 预提交阶段，占用资源并开始，但是不提交
      3. 提交阶段， 提交开始，如果在第二阶段有失败的直接返回
   2. 引入超时机制
      1. 如果在预提交阶段超时，立刻回滚
      2. 如果在提交阶段超时，立刻提交
   3. 缺点：
      1. 当在预提交阶段的时候，如果协调者和部分的参与者失败，或者是提交了或者是回滚了。这样依然会数据 不一致
3. 柔性事务
   1. 补偿型 
      1. **tcc 属于典型的代表**
         1. 优点：  可以自定义数据粒度，然后可以提升吞吐量
         2. 缺点： 代码开发成本高，需要业务方提供 tcc 操作   需要根据网络、系统故障等不同失败原因实现不同的回滚策略， 实现难度大，一般借助 TCC 开源框架，ByteTCC，TCC-transaction，Himly
      2. 2PC和3PC都是数据库层面的操作，对于开发人员无感知；而TCC是业务层的操作，对开发人员来说具有较高的开发成本。
      3. 2PC是一个整体的长事务，是刚性事务；而TCC是一组本地短事务，是柔性事务；
      4. 2PC是全局锁定资源，所有参与者阻塞等待事务管理器的通知；而TCC的资源锁定在于Try操作，业务方可以灵活选择业务资源的锁定粒度。
   2. 通知型
      1. 事务消息
         1. mq的半消息
      2. 本地消息表
         1. 缺乏伸缩性能
         2. 高并发不行
         3. 成本简单
         4. 不够灵活
      3. 最大努力通知
         1. mq的ack机制、
         2. 用到的服务模式：可查询操作、幂等操作；
         3. 被动方的处理结果不影响主动方的处理结果；
         4. 适用于对业务最终一致性的时间敏感度低的系统；
         5. 适合跨企业的系统间的操作，或者企业内部比较独立的系统间的操作，比如银行通知、商户通知等；

